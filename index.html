<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Control de Mercader√≠a ‚Äî Airi</title>
<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>
<style>
  :root{
    --bg:#f5f7fb; --card:#ffffff; --accent:#0b6efd; --muted:#6b7280;
    --danger:#dc2626; --radius:10px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter, Arial, sans-serif;background:var(--bg);color:#111}
  header{background:linear-gradient(90deg,var(--accent),#0747c9);color:white;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px}
  header h1{margin:0;font-size:1.05rem}
  header .meta{font-size:0.9rem;opacity:0.95}
  nav{display:flex;gap:8px;padding:10px;justify-content:center;background:transparent}
  .btn{background:var(--accent);color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid rgba(0,0,0,0.08);color:#111}
  .container{max-width:1100px;margin:16px auto;padding:0 12px}
  .card{background:var(--card);border-radius:var(--radius);padding:12px;margin-bottom:12px;box-shadow:0 6px 20px rgba(10,20,40,0.04)}
  .grid{display:grid;grid-template-columns:1fr 120px 120px 120px;gap:8px;align-items:center}
  input, select {padding:8px;border-radius:8px;border:1px solid #e6eef8;font-size:0.95rem;width:100%}
  .table-wrapper{overflow:auto;border-radius:8px;border:1px solid #e8eef8;margin-top:10px;max-height:52vh}
  table{width:100%;border-collapse:collapse;font-size:0.95rem}
  thead th{position:sticky;top:0;background:linear-gradient(90deg,var(--accent),#0a58d8);color:#fff;padding:10px}
  th, td{padding:8px;border-bottom:1px solid #f1f5f9;text-align:center}
  td.left{text-align:left;padding-left:12px}
  .muted{color:var(--muted);font-size:0.9rem}
  .actions{display:flex;gap:6px;justify-content:center}
  .small{font-size:0.88rem}
  .totals{display:flex;gap:12px;align-items:center}
  .right{margin-left:auto}
  .hidden{display:none}
  @media(max-width:820px){
    .grid{grid-template-columns:1fr 120px;row-gap:8px}
    thead th, td{font-size:0.85rem;padding:6px}
  }
  .back{background:#eff6ff;border-radius:8px;padding:8px 10px;border:1px solid #dbeafe;cursor:pointer}
  .danger{background:var(--danger);color:white;padding:8px 10px;border-radius:8px;border:none;cursor:pointer}
  .entry{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;border:1px solid #f1f5f9;margin-bottom:8px}
  .entry .left{font-weight:500}
  .viewport {
    position: relative;
    width: 0;
    height: 0;
    overflow: hidden;
  }
</style>
</head>

<body>
<header>
  <div>
    <h1>üì¶ Control de Mercader√≠a</h1>
    <div class="muted small">Seleccion√° Sal√≥n o Dep√≥sito.</div>
  </div>
  <div class="totals">
    <div class="small">Productos: <strong id="totalProducts">0</strong></div>
    <div class="small">Unidades totales: <strong id="totalUnits">0</strong></div>
  </div>
</header>

<nav>
  <button class="btn" onclick="showView('conteo')">‚ûï Conteo</button>
  <button class="btn ghost" onclick="showView('historialGeneral')">üïí Historial</button>
  <button class="btn ghost" id="btnClearAll">üßπ Borrar todo</button>
</nav>

<main class="container">
  <section id="conteo" class="card">
    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
      <div style="min-width:180px">
        <label class="small muted">Destino</label>
        <select id="destinoSelect">
          <option value="salon">Sal√≥n</option>
          <option value="deposito">Dep√≥sito</option>
        </select>
      </div>

      <div style="flex:1">
        <label class="small muted">EAN</label>
        <input id="ean" type="text" placeholder="C√≥digo de barras ‚Äî Enter" />
      </div>

      <div id="interactive" class="viewport"></div>
      <button class="btn ghost" id="scanBtn">Escanear</button>

      <div style="width:150px">
        <label class="small muted">Cantidad</label>
        <input id="cantidad" type="number" placeholder="ej. 20" />
      </div>

      <div style="width:120px">
        <label class="small muted">&nbsp;</label>
        <button class="btn" id="addBtn">Agregar</button>
      </div>

      <div style="width:220px; margin-left:auto">
        <label class="small muted">Buscar</label>
        <input id="search" type="text" placeholder="Buscar..." />
      </div>
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>EAN</th><th>PLU</th><th>DESCRIPCI√ìN</th>
            <th>Sal√≥n</th><th>Dep√≥sito</th><th>Total</th><th>Acc.</th>
          </tr>
        </thead>
        <tbody id="tablaProductos"></tbody>
      </table>
    </div>

    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn" onclick="guardarSnapshot()">üíæ Guardar Conteo</button>
      <button class="btn ghost" id="exportJsonAll">üì§ Exportar JSON</button>
      <input type="file" id="importJson" accept=".json" hidden>
      <button class="btn ghost" onclick="document.getElementById('importJson').click();">‚¨ÜÔ∏è Importar JSON</button>
      <div class="right muted small">Sugerencia: escane√° y luego Enter.</div>
    </div>
  </section>

  <section id="historialProducto" class="card hidden">
    <div style="display:flex;gap:12px;align-items:center">
      <button class="back" onclick="showView('conteo')">‚¨Ö Volver</button>
      <div style="flex:1">
        <h3 id="histTitle" style="margin:0"></h3>
        <div class="muted small" id="histSub"></div>
      </div>
      <div style="display:flex;gap:8px">
        <div class="small muted" id="histTotal"></div>
        <button class="danger" id="clearThisHistory">üóë Borrar todo</button>
      </div>
    </div>

    <div id="entriesList" style="margin-top:8px"></div>

    <div style="display:flex;gap:8px;margin-top:10px">
      <input id="newEntryValue" type="number" placeholder="Agregar entrada (+/-)" style="flex:1" />
      <button class="btn" id="addEntryBtn">Agregar</button>
    </div>
  </section>

  <section id="historialGeneral" class="card hidden">
    <h3>Historial de Conteos Guardados</h3>
    <div id="listaSnapshots"></div>
  </section>
</main>

<script>
/* ============================================================
   üîπ DATOS
   ============================================================ */
let products = JSON.parse(localStorage.getItem('products_v2') || '[]');
let conteos = JSON.parse(localStorage.getItem('conteos_v2') || '[]');

const eanEl = document.getElementById('ean');
const cantidadEl = document.getElementById('cantidad');
const tablaProductos = document.getElementById('tablaProductos');
const totalProductsEl = document.getElementById('totalProducts');
const totalUnitsEl = document.getElementById('totalUnits');
const searchEl = document.getElementById('search');
const destinoSelect = document.getElementById('destinoSelect');

document.getElementById('btnClearAll').onclick = clearAllData;

/* ============================================================
   üîπ SUMAS Y TOTALES
   ============================================================ */
function sumArray(arr){ return arr.reduce((s,v)=>s+Number(v||0),0); }
function getTotals(){
  return {
    totalProducts: products.length,
    totalUnits: products.reduce((s,p)=>s+sumArray(p.salon)+sumArray(p.deposito),0)
  };
}

/* ============================================================
   üîπ TABLA PRINCIPAL
   ============================================================ */
function renderTable(){
  products.sort((a,b)=> (a.detalle||'').localeCompare(b.detalle||'') );

  tablaProductos.innerHTML = '';
  const q = searchEl.value.toLowerCase();

  products.forEach((p,i)=>{
    if(q){
      const matches = p.ean.toLowerCase().includes(q) ||
                      (p.plu||'').toLowerCase().includes(q) ||
                      (p.detalle||'').toLowerCase().includes(q);
      if(!matches) return;
    }

    const salon = sumArray(p.salon);
    const depo = sumArray(p.deposito);

    tablaProductos.innerHTML += `
      <tr>
        <td>${p.ean}</td>
        <td class="left" ondblclick="startEdit(${i},'plu')">${p.plu || ''}</td>
        <td class="left" ondblclick="startEdit(${i},'detalle')">${p.detalle || ''}</td>
        <td style="cursor:pointer;color:#0a58d8" onclick="openHistory(${i},'salon')">${salon}</td>
        <td style="cursor:pointer;color:#0a58d8" onclick="openHistory(${i},'deposito')">${depo}</td>
        <td>${salon+depo}</td>
        <td><button class="btn ghost" onclick="deleteProduct(${i})">‚ùå</button></td>
      </tr>
    `;
  });

  const t = getTotals();
  totalProductsEl.textContent = t.totalProducts;
  totalUnitsEl.textContent = t.totalUnits;
}
renderTable();

/* ============================================================
   üîπ AGREGAR PRODUCTOS
   ============================================================ */
document.getElementById('addBtn').onclick = agregarPorDestino;

function agregarPorDestino(){
  const ean = eanEl.value.trim();
  const cant = Number(cantidadEl.value || 0);
  if(!ean || !cant){ alert('Complet√° EAN y Cantidad'); return; }

  let p = products.find(x=>x.ean===ean);
  if(!p) products.push(p={ean, plu:'', detalle:'', salon:[], deposito:[]});

  p[destinoSelect.value].push(cant);
  save();
  eanEl.value = cantidadEl.value = '';
  renderTable();
  eanEl.focus();
}

/* ============================================================
   üîπ EDITAR CAMPOS
   ============================================================ */
function startEdit(i,campo){
  const val = prompt("Nuevo valor:", products[i][campo] || "");
  if(val===null) return;
  products[i][campo] = val.trim();
  save();
  renderTable();
}

/* ============================================================
   üîπ HISTORIAL DE PRODUCTOS
   ============================================================ */
let currentHist = {idx:null, sector:null};

function openHistory(i,sector){
  currentHist={idx:i, sector};
  const p = products[i];

  document.getElementById('histTitle').textContent = p.detalle || p.ean;
  document.getElementById('histSub').textContent = `EAN: ${p.ean} ‚Äî PLU: ${p.plu||'-'}`;
  showView('historialProducto');
  renderEntries();
}

function renderEntries(){
  const list = document.getElementById('entriesList');
  list.innerHTML='';

  const arr = products[currentHist.idx][currentHist.sector];
  if(arr.length===0){ list.innerHTML='<div class="muted">Sin entradas.</div>'; return; }

  arr.forEach((v,i)=>{
    list.innerHTML += `
      <div class="entry">
        <div class="left">${v>=0? '+'+v:v}</div>
        <button class="btn ghost" onclick="deleteEntry(${i})">‚ùå</button>
      </div>`;
  });

  document.getElementById('histTotal').textContent = "Total: " + sumArray(arr);
}

function deleteEntry(i){
  products[currentHist.idx][currentHist.sector].splice(i,1);
  save();
  renderEntries();
  renderTable();
}

document.getElementById('clearThisHistory').onclick = function(){
  if(!confirm("Eliminar todo este historial?")) return;
  products[currentHist.idx][currentHist.sector]=[];
  save();
  renderEntries();
  renderTable();
};

document.getElementById('addEntryBtn').onclick = function(){
  const v = Number(document.getElementById('newEntryValue').value);
  if(!v) return;
  products[currentHist.idx][currentHist.sector].push(v);
  save();
  renderEntries();
  renderTable();
};

/* ============================================================
   üîπ SNAPSHOTS
   ============================================================ */
function guardarSnapshot(){
  if(products.length===0){ alert("No hay productos"); return; }
  conteos.push({
    fecha: new Date().toLocaleString(),
    products: JSON.parse(JSON.stringify(products))
  });
  save();
  alert("Guardado ‚úî");
}

function renderSnapshots(){
  const box=document.getElementById('listaSnapshots');
  box.innerHTML='';
  conteos.slice().reverse().forEach((c,rev)=>{
    const i = conteos.length-1-rev;
    box.innerHTML+=`
      <div style="border:1px solid #ddd;padding:8px;border-radius:8px;margin:6px 0">
        <strong>${c.fecha}</strong><br>
        <button class="btn" onclick="loadSnapshot(${i})">Cargar</button>
      </div>`;
  });
}
document.getElementById('exportJsonAll').onclick=()=>download(JSON.stringify({products,conteos},null,2),'datos.json','application/json');

document.getElementById('importJson').onchange=function(e){
  const f=e.target.files[0];
  if(!f) return;
  const r=new FileReader();
  r.onload=function(){
    const data=JSON.parse(r.result);
    products=data.products||[];
    conteos=data.conteos||[];
    save();
    renderTable();
    renderSnapshots();
  };
  r.readAsText(f);
};

/* ============================================================
   üîπ SCANEO MEJORADO (VERSI√ìN FINAL)
   ============================================================ */
const scanBtn=document.getElementById('scanBtn');
let scanning=false;

scanBtn.onclick = ()=>{
  if(scanning) stopScanner();
  else startScanner();
};

function startScanner(){
  Quagga.init({
    inputStream:{
      name:"Live",
      type:"LiveStream",
      target:document.querySelector("#interactive"),
      constraints:{
        width:{ideal:640},
        height:{ideal:480},
        facingMode:"environment",
        focusMode:"continuous",
        torch:true
      }
    },
    locator:{
      patchSize:"medium",
      halfSample:true
    },
    decoder:{
      readers:["ean_reader","ean_8_reader"]
    },
    locate:true
  }, err=>{
    if(err){ alert("Error "+err); return; }

    Quagga.start();
    scanning=true;
    scanBtn.textContent="Detener";

    const vp=document.getElementById('interactive');
    vp.style.width="320px";
    vp.style.height="240px";

    addScannerOverlay();
  });

  let last=null;

  Quagga.onDetected(res=>{
    const code=res.codeResult.code;
    if(!code || code.length<8) return;
    if(code===last) return;
    last=code;

    eanEl.value=code;
    stopScanner();
  });
}

function stopScanner(){
  Quagga.stop();
  scanning=false;
  scanBtn.textContent="Escanear";

  const vp=document.getElementById('interactive');
  vp.style.width="0px";
  vp.style.height="0px";

  const over=document.getElementById("scannerOverlay");
  if(over) over.remove();
}

/* overlay */
function addScannerOverlay(){
  const vp=document.querySelector('#interactive');
  const o=document.createElement('div');
  o.id="scannerOverlay";
  o.style.position="absolute";
  o.style.top="25%";
  o.style.left="10%";
  o.style.width="80%";
  o.style.height="50%";
  o.style.border="3px solid white";
  o.style.borderRadius="12px";
  o.style.pointerEvents="none";
  vp.appendChild(o);
}

/* ============================================================
   üîπ UTILIDADES
   ============================================================ */
function save(){
  localStorage.setItem('products_v2',JSON.stringify(products));
  localStorage.setItem('conteos_v2',JSON.stringify(conteos));
}

function clearAllData(){
  if(!confirm("¬øBorrar TODO?")) return;
  products=[]; conteos=[];
  save();
  renderTable();
  renderSnapshots();
}

/* vistas */
function showView(id){
  document.getElementById('conteo').classList.add('hidden');
  document.getElementById('historialProducto').classList.add('hidden');
  document.getElementById('historialGeneral').classList.add('hidden');
  document.getElementById(id).classList.remove('hidden');
  if(id==="historialGeneral") renderSnapshots();
}

/* descargar */
function download(content,filename,type){
  const blob=new Blob([content],{type});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=filename;
  a.click();
}
</script>

</body>
</html>
